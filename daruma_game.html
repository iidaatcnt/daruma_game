<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã ã‚‹ã¾ã•ã‚“ãŒè»¢ã‚“ã ã‚²ãƒ¼ãƒ </title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Arial', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h1 {
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            margin-bottom: 20px;
        }

        #gameCanvas {
            border: 3px solid #fff;
            border-radius: 10px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            background: #87CEEB;
        }

        .controls {
            margin-top: 20px;
            color: white;
            text-align: center;
        }

        .controls button {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            margin: 5px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .controls button:hover {
            background: #ff5252;
            transform: translateY(-2px);
        }

        .status {
            margin-top: 15px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .instructions {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            color: white;
            text-align: center;
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body>
    <h1>ğŸŒ ã ã‚‹ã¾ã•ã‚“ãŒè»¢ã‚“ã  ğŸŒ</h1>
    <canvas id="gameCanvas" width="800" height="400"></canvas>
    
    <div class="controls">
        <button onclick="startGame()">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
        <button onclick="resetGame()">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
    
    <div class="status" id="status">ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã‚’é•·æŠ¼ã—ã—ã¦å‰é€²ï¼éŸ³å£°ãŒæµã‚Œã¦ã„ã‚‹é–“ã¯å®‰å…¨ã§ã™ï¼</div>
    
    <div class="instructions">
        <strong>éŠã³æ–¹:</strong><br>
        ğŸƒâ€â™‚ï¸ ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã‚’æŠ¼ã—ç¶šã‘ã¦å‰é€²<br>
        ğŸµ éŸ³å£°ãŒæµã‚Œã¦ã„ã‚‹é–“ã¯å®‰å…¨ã«ç§»å‹•å¯èƒ½<br>
        ğŸš« éŸ³å£°åœæ­¢å¾Œã¯ã ã‚‹ã¾ãŒæŒ¯ã‚Šè¿”ã‚‹ã®ã§å³åº§ã«åœæ­¢<br>
        ğŸ ã‚´ãƒ¼ãƒ«ã¾ã§è¾¿ã‚Šç€ã‘ã°ã‚¯ãƒªã‚¢ï¼
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const statusDiv = document.getElementById('status');

        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
        let gameState = 'waiting'; // waiting, playing, safe, danger, gameover, win
        let player = {
            x: 50,
            y: 300,
            width: 40,
            height: 60,
            isMoving: false,
            animFrame: 0,
            lastStepTime: 0
        };

        let daruma = {
            x: 700,
            y: 280,
            width: 60,
            height: 80,
            isTurned: false,
            turnAnimation: 0,
            headRotation: 0
        };

        let gameTimer = 0;
        let nextTurnTime = 0;
        let dangerDuration = 0;
        let score = 0;
        let level = 1;
        
        // ã‚­ãƒ¼å…¥åŠ›
        let keys = {};
        
        // ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªè¦ç´ 
        let darumaAudio;
        let isAudioLoaded = false;

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space') {
                e.preventDefault();
                keys.space = true;
            }
        });

        document.addEventListener('keyup', (e) => {
            if (e.code === 'Space') {
                e.preventDefault();
                keys.space = false;
            }
        });

        // éŸ³å£°åˆæœŸåŒ–
        function initAudio() {
            darumaAudio = new Audio('daruma_game.wav');
            darumaAudio.preload = 'auto';
            
            darumaAudio.addEventListener('loadeddata', () => {
                isAudioLoaded = true;
                console.log('éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ');
            });
            
            darumaAudio.addEventListener('error', (e) => {
                console.log('éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', e);
                updateStatus('âš ï¸ éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚daruma_game.wavã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
            });
            
            darumaAudio.addEventListener('ended', () => {
                // éŸ³å£°çµ‚äº†æ™‚ã«ã ã‚‹ã¾ãŒæŒ¯ã‚Šè¿”ã‚‹ï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãï¼‰
                if (gameState === 'playing') {
                    // æŒ¯ã‚Šè¿”ã‚Šã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
                    let rotationSpeed = 0.2;
                    const turnAnimation = () => {
                        daruma.headRotation += rotationSpeed;
                        if (daruma.headRotation >= Math.PI) {
                            daruma.headRotation = Math.PI;
                            daruma.isTurned = true;
                            gameState = 'danger';
                            dangerDuration = 1500 + Math.random() * 1000; // 1.5-2.5ç§’
                            updateStatus('âš ï¸ ã ã‚‹ã¾ãŒæŒ¯ã‚Šè¿”ã£ãŸï¼å‹•ã„ã¡ã‚ƒãƒ€ãƒ¡ï¼');
                        } else {
                            requestAnimationFrame(turnAnimation);
                        }
                    };
                    turnAnimation();
                }
            });
        }

        // åŠ¹æœéŸ³ç”Ÿæˆ
        function playWinSound() {
            // ã‚´ãƒ¼ãƒ«æ™‚ã®å‹åˆ©ãƒ•ã‚¡ãƒ³ãƒ•ã‚¡ãƒ¼ãƒ¬
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const notes = [523.25, 659.25, 783.99, 1046.50]; // C5, E5, G5, C6
            const durations = [0.3, 0.3, 0.3, 0.6];
            
            notes.forEach((freq, index) => {
                setTimeout(() => {
                    const oscillator = audioCtx.createOscillator();
                    const gainNode = audioCtx.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioCtx.destination);
                    
                    oscillator.frequency.setValueAtTime(freq, audioCtx.currentTime);
                    oscillator.type = 'triangle';
                    
                    gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + durations[index]);
                    
                    oscillator.start(audioCtx.currentTime);
                    oscillator.stop(audioCtx.currentTime + durations[index]);
                }, index * 200);
            });
        }

        function playGameOverSound() {
            // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼æ™‚ã®ä¸‹é™éŸ³
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const notes = [440, 369.99, 293.66, 220]; // A4, F#4, D4, A3
            
            notes.forEach((freq, index) => {
                setTimeout(() => {
                    const oscillator = audioCtx.createOscillator();
                    const gainNode = audioCtx.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioCtx.destination);
                    
                    oscillator.frequency.setValueAtTime(freq, audioCtx.currentTime);
                    oscillator.type = 'sawtooth';
                    
                    gainNode.gain.setValueAtTime(0.4, audioCtx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4);
                    
                    oscillator.start(audioCtx.currentTime);
                    oscillator.stop(audioCtx.currentTime + 0.4);
                }, index * 100);
            });
        }

        function playStepSound() {
            // æ­©è¡Œæ™‚ã®åŠ¹æœéŸ³
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            oscillator.frequency.setValueAtTime(200 + Math.random() * 100, audioCtx.currentTime);
            oscillator.type = 'square';
            
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
            
            oscillator.start(audioCtx.currentTime);
            oscillator.stop(audioCtx.currentTime + 0.1);
        }

        // ã‚²ãƒ¼ãƒ é–‹å§‹
        function startGame() {
            initAudio();
            gameState = 'playing';
            player.x = 50;
            player.isMoving = false;
            daruma.isTurned = false;
            gameTimer = 0;
            nextTurnTime = 2000; // æœ€åˆã¯2ç§’å¾Œã«é–‹å§‹
            dangerDuration = 0;
            score = 0;
            level = 1;
            updateStatus('ã‚²ãƒ¼ãƒ é–‹å§‹ï¼éŸ³å£°ãŒæµã‚Œã¦ã„ã‚‹é–“ã¯å®‰å…¨ã§ã™ï¼');
            
            // å°‘ã—å¾…ã£ã¦ã‹ã‚‰æœ€åˆã®éŸ³å£°å†ç”Ÿ
            setTimeout(() => {
                playDarumaVoice();
            }, 1000);
        }

        // ã‚²ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
        function resetGame() {
            gameState = 'waiting';
            player.x = 50;
            player.isMoving = false;
            player.lastStepTime = 0;
            daruma.isTurned = false;
            daruma.headRotation = 0;
            gameTimer = 0;
            score = 0;
            level = 1;
            
            // éŸ³å£°åœæ­¢
            if (darumaAudio) {
                darumaAudio.pause();
                darumaAudio.currentTime = 0;
            }
            
            updateStatus('ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã‚’é•·æŠ¼ã—ã—ã¦å‰é€²ï¼éŸ³å£°ãŒæµã‚Œã¦ã„ã‚‹é–“ã¯å®‰å…¨ã§ã™ï¼');
        }

        // ã ã‚‹ã¾ã®å£°ã‚’å†ç”Ÿ
        function playDarumaVoice() {
            if (isAudioLoaded && gameState === 'playing') {
                darumaAudio.currentTime = 0;
                darumaAudio.play().catch(e => {
                    console.log('éŸ³å£°å†ç”Ÿã‚¨ãƒ©ãƒ¼:', e);
                    updateStatus('âš ï¸ éŸ³å£°ã®å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã§éŸ³å£°ãŒæœ‰åŠ¹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                });
                updateStatus('ğŸµ ã ã‚‹ã¾ã•ã‚“ãŒã“ã‚ã‚“ã ã€œâ™ª ä»Šã®ã†ã¡ã«é€²ã‚‚ã†ï¼');
            }
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function updateStatus(message) {
            statusDiv.textContent = message;
        }

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æç”»ï¼ˆèµ°ã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
        function drawPlayer() {
            ctx.save();
            
            // å½±
            ctx.fillStyle = 'rgba(0,0,0,0.2)';
            ctx.fillRect(player.x, player.y + player.height, player.width, 8);
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®æ™‚é–“è¨ˆç®—
            const animSpeed = player.isMoving ? 0.3 : 0;
            const armSwing = Math.sin(gameTimer * animSpeed) * 8;
            const legSwing = Math.sin(gameTimer * animSpeed + Math.PI) * 10;
            const bodyBob = player.isMoving ? Math.sin(gameTimer * animSpeed * 2) * 2 : 0;
            
            // ä½“ï¼ˆèµ°ã‚‹æ™‚ã«ä¸Šä¸‹ã«æºã‚Œã‚‹ï¼‰
            ctx.fillStyle = '#4ECDC4';
            ctx.fillRect(player.x + 8, player.y + 20 + bodyBob, 24, 30);
            
            // é ­
            ctx.fillStyle = '#FFE4B5';
            ctx.beginPath();
            ctx.arc(player.x + 20, player.y + 15 + bodyBob, 15, 0, 2 * Math.PI);
            ctx.fill();
            
            // é«ª
            ctx.fillStyle = '#8B4513';
            ctx.beginPath();
            ctx.arc(player.x + 20, player.y + 8 + bodyBob, 12, Math.PI, 2 * Math.PI);
            ctx.fill();
            
            // ç›®ï¼ˆèµ°ã‚‹æ™‚ã¯é›†ä¸­ã—ãŸè¡¨æƒ…ï¼‰
            ctx.fillStyle = 'black';
            if (player.isMoving) {
                // é›†ä¸­ã—ãŸç›®
                ctx.fillRect(player.x + 16, player.y + 11 + bodyBob, 3, 2);
                ctx.fillRect(player.x + 23, player.y + 11 + bodyBob, 3, 2);
            } else {
                // æ™®é€šã®ç›®
                ctx.beginPath();
                ctx.arc(player.x + 16, player.y + 12 + bodyBob, 2, 0, 2 * Math.PI);
                ctx.arc(player.x + 24, player.y + 12 + bodyBob, 2, 0, 2 * Math.PI);
                ctx.fill();
            }
            
            // å£
            if (gameState === 'danger' && player.isMoving) {
                ctx.strokeStyle = 'red';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(player.x + 20, player.y + 18 + bodyBob, 3, 0, Math.PI);
                ctx.stroke();
            } else if (player.isMoving) {
                // èµ°ã‚‹æ™‚ã¯å£ã‚’é–‹ã
                ctx.fillStyle = 'black';
                ctx.beginPath();
                ctx.ellipse(player.x + 20, player.y + 18 + bodyBob, 2, 3, 0, 0, 2 * Math.PI);
                ctx.fill();
            } else {
                ctx.strokeStyle = 'black';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.arc(player.x + 20, player.y + 18 + bodyBob, 3, Math.PI, 0);
                ctx.stroke();
            }
            
            // è…•ï¼ˆèµ°ã‚‹æ™‚ã«å¤§ããæŒ¯ã‚‹ï¼‰
            ctx.fillStyle = '#4ECDC4';
            ctx.strokeStyle = '#4ECDC4';
            ctx.lineWidth = 6;
            ctx.lineCap = 'round';
            
            // å·¦è…•
            ctx.beginPath();
            ctx.moveTo(player.x + 8, player.y + 25 + bodyBob);
            ctx.lineTo(player.x + 2 + armSwing, player.y + 35 + bodyBob);
            ctx.stroke();
            
            // å³è…•
            ctx.beginPath();
            ctx.moveTo(player.x + 32, player.y + 25 + bodyBob);
            ctx.lineTo(player.x + 38 - armSwing, player.y + 35 + bodyBob);
            ctx.stroke();
            
            // è„šï¼ˆèµ°ã‚‹æ™‚ã«å¤§ããå‹•ãï¼‰
            ctx.lineWidth = 8;
            
            // å·¦è„š
            ctx.beginPath();
            ctx.moveTo(player.x + 12, player.y + 50 + bodyBob);
            ctx.lineTo(player.x + 8 + legSwing, player.y + 65 + bodyBob);
            ctx.stroke();
            
            // å³è„š
            ctx.beginPath();
            ctx.moveTo(player.x + 28, player.y + 50 + bodyBob);
            ctx.lineTo(player.x + 32 - legSwing, player.y + 65 + bodyBob);
            ctx.stroke();
            
            // è¶³
            ctx.fillStyle = '#2C3E50';
            if (player.isMoving) {
                ctx.fillRect(player.x + 6 + legSwing, player.y + 63 + bodyBob, 8, 4);
                ctx.fillRect(player.x + 30 - legSwing, player.y + 63 + bodyBob, 8, 4);
            } else {
                ctx.fillRect(player.x + 10, player.y + 63, 8, 4);
                ctx.fillRect(player.x + 22, player.y + 63, 8, 4);
            }
            
            // èµ°ã‚‹æ™‚ã®ã‚¹ãƒ”ãƒ¼ãƒ‰ãƒ©ã‚¤ãƒ³
            if (player.isMoving && gameState === 'playing') {
                ctx.strokeStyle = 'rgba(255,255,255,0.6)';
                ctx.lineWidth = 2;
                for (let i = 0; i < 3; i++) {
                    ctx.beginPath();
                    ctx.moveTo(player.x - 10 - i * 8, player.y + 20 + i * 10);
                    ctx.lineTo(player.x - 20 - i * 8, player.y + 25 + i * 10);
                    ctx.stroke();
                }
            }
            
            ctx.restore();
        }

        // ã ã‚‹ã¾æç”»ï¼ˆæŒ¯ã‚Šè¿”ã‚Šã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
        function drawDaruma() {
            ctx.save();
            
            // å½±
            ctx.fillStyle = 'rgba(0,0,0,0.2)';
            ctx.fillRect(daruma.x, daruma.y + daruma.height, daruma.width, 8);
            
            // ä½“ï¼ˆã ã‚‹ã¾ï¼‰
            ctx.fillStyle = '#FF6B6B';
            ctx.beginPath();
            ctx.ellipse(daruma.x + 30, daruma.y + 50, 25, 35, 0, 0, 2 * Math.PI);
            ctx.fill();
            
            // ä½“ã®è£…é£¾
            ctx.fillStyle = '#FFD700';
            ctx.fillRect(daruma.x + 20, daruma.y + 40, 20, 4);
            ctx.fillRect(daruma.x + 22, daruma.y + 55, 16, 3);
            
            // é¡”ï¼ˆå›è»¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãï¼‰
            ctx.save();
            ctx.translate(daruma.x + 30, daruma.y + 25);
            ctx.rotate(daruma.headRotation);
            
            // é¡”ã®èƒŒæ™¯
            ctx.fillStyle = '#FFE4B5';
            ctx.beginPath();
            ctx.arc(0, 0, 20, 0, 2 * Math.PI);
            ctx.fill();
            
            if (daruma.isTurned || daruma.headRotation !== 0) {
                // æŒ¯ã‚Šè¿”ã£ãŸé¡”ï¼ˆæ€’ã£ãŸè¡¨æƒ…ï¼‰
                ctx.fillStyle = 'red';
                ctx.beginPath();
                ctx.arc(-5, -3, 3, 0, 2 * Math.PI);
                ctx.arc(5, -3, 3, 0, 2 * Math.PI);
                ctx.fill();
                
                // æ€’ã£ãŸå£
                ctx.strokeStyle = 'red';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(0, 5, 5, 0, Math.PI);
                ctx.stroke();
                
                // æ€’ã‚Šãƒãƒ¼ã‚¯
                ctx.strokeStyle = 'red';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(-12, -8);
                ctx.lineTo(-8, -12);
                ctx.moveTo(-8, -8);
                ctx.lineTo(-12, -12);
                ctx.stroke();
                
                // çœ‰æ¯›
                ctx.strokeStyle = 'black';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(-8, -6);
                ctx.lineTo(-2, -8);
                ctx.moveTo(2, -8);
                ctx.lineTo(8, -6);
                ctx.stroke();
                
                // è­¦å‘Šã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
                if (player.isMoving && daruma.isTurned) {
                    ctx.restore(); // å›è»¢ã‚’æˆ»ã—ã¦ã‹ã‚‰å…¨ç”»é¢ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
                    ctx.fillStyle = 'rgba(255,0,0,0.3)';
                    ctx.fillRect(-daruma.x - 30, -daruma.y - 25, canvas.width, canvas.height);
                    ctx.save();
                    ctx.translate(daruma.x + 30, daruma.y + 25);
                    ctx.rotate(daruma.headRotation);
                }
            } else {
                // å¾Œã‚å‘ãã®é¡”
                ctx.fillStyle = '#8B4513';
                ctx.fillRect(-10, -15, 20, 25);
                
                // é«ªã®è©³ç´°
                ctx.fillStyle = '#654321';
                ctx.fillRect(-12, -18, 24, 8);
                
                // é«ªã®æŸ
                for (let i = -8; i <= 8; i += 4) {
                    ctx.fillRect(i - 1, -20, 2, 4);
                }
            }
            
            ctx.restore();
            ctx.restore();
        }

        // èƒŒæ™¯æç”»
        function drawBackground() {
            // ç©º
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#87CEEB');
            gradient.addColorStop(1, '#98FB98');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // é›²
            ctx.fillStyle = 'rgba(255,255,255,0.8)';
            ctx.beginPath();
            ctx.arc(150, 80, 25, 0, 2 * Math.PI);
            ctx.arc(180, 80, 35, 0, 2 * Math.PI);
            ctx.arc(210, 80, 25, 0, 2 * Math.PI);
            ctx.fill();
            
            ctx.beginPath();
            ctx.arc(500, 60, 20, 0, 2 * Math.PI);
            ctx.arc(520, 60, 30, 0, 2 * Math.PI);
            ctx.arc(545, 60, 20, 0, 2 * Math.PI);
            ctx.fill();
            
            // åœ°é¢
            ctx.fillStyle = '#90EE90';
            ctx.fillRect(0, 360, canvas.width, 40);
            
            // ã‚¹ã‚¿ãƒ¼ãƒˆãƒ©ã‚¤ãƒ³
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 3;
            ctx.setLineDash([10, 10]);
            ctx.beginPath();
            ctx.moveTo(80, 360);
            ctx.lineTo(80, 400);
            ctx.stroke();
            
            // ã‚´ãƒ¼ãƒ«ãƒ©ã‚¤ãƒ³
            ctx.strokeStyle = 'red';
            ctx.lineWidth = 3;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(650, 300);
            ctx.lineTo(650, 400);
            ctx.stroke();
            ctx.setLineDash([]);
            
            // ã‚´ãƒ¼ãƒ«æ——
            ctx.fillStyle = 'red';
            ctx.fillRect(645, 250, 10, 50);
            ctx.fillStyle = 'white';
            ctx.fillRect(655, 250, 30, 20);
            ctx.fillStyle = 'red';
            ctx.font = '12px Arial';
            ctx.fillText('GOAL', 660, 262);
        }

        // UIæç”»
        function drawUI() {
            // ã‚¹ã‚³ã‚¢
            ctx.fillStyle = 'white';
            ctx.font = 'bold 20px Arial';
            ctx.fillText(`ã‚¹ã‚³ã‚¢: ${score}`, 20, 30);
            ctx.fillText(`ãƒ¬ãƒ™ãƒ«: ${level}`, 20, 55);
            
            // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼
            const progress = (player.x - 50) / (650 - 50);
            ctx.fillStyle = 'rgba(0,0,0,0.3)';
            ctx.fillRect(20, 80, 200, 20);
            ctx.fillStyle = '#4ECDC4';
            ctx.fillRect(20, 80, 200 * progress, 20);
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 2;
            ctx.strokeRect(20, 80, 200, 20);
            
            // çŠ¶æ…‹è¡¨ç¤º
            if (gameState === 'danger') {
                ctx.fillStyle = 'red';
                ctx.font = 'bold 24px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('æ­¢ã¾ã‚Œï¼', canvas.width / 2, 50);
                ctx.textAlign = 'left';
            } else if (gameState === 'playing') {
                ctx.fillStyle = 'green';
                ctx.font = 'bold 24px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('ğŸµ å®‰å…¨ ğŸµ', canvas.width / 2, 50);
                ctx.textAlign = 'left';
            }
        }

        // ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯æ›´æ–°
        function update() {
            if (gameState === 'waiting' || gameState === 'gameover' || gameState === 'win') {
                return;
            }
            
            gameTimer += 16; // ç´„60FPS
            
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç§»å‹•ï¼ˆéŸ³å£°å†ç”Ÿä¸­ã®ã¿å¯èƒ½ï¼‰
            if (gameState === 'playing') {
                player.isMoving = keys.space;
                
                if (player.isMoving) {
                    player.x += 2;
                    score += 1;
                    
                    // æ­©è¡ŒåŠ¹æœéŸ³ï¼ˆä¸€å®šé–“éš”ã§å†ç”Ÿï¼‰
                    if (gameTimer - player.lastStepTime > 300) {
                        playStepSound();
                        player.lastStepTime = gameTimer;
                    }
                    
                    // ã‚´ãƒ¼ãƒ«åˆ¤å®š
                    if (player.x >= 630) {
                        gameState = 'win';
                        if (darumaAudio) {
                            darumaAudio.pause();
                        }
                        playWinSound();
                        updateStatus('ğŸ‰ ã‚´ãƒ¼ãƒ«ï¼ãŠã‚ã§ã¨ã†ï¼ ğŸ‰');
                        return;
                    }
                }
            }
            
            // å±é™ºçŠ¶æ…‹ã®å‡¦ç†
            if (gameState === 'danger') {
                dangerDuration -= 16;
                
                // å‹•ã„ã¦ã„ã‚‹é–“ã¯ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼åˆ¤å®š
                if (keys.space) {
                    gameState = 'gameover';
                    if (darumaAudio) {
                        darumaAudio.pause();
                    }
                    playGameOverSound();
                    updateStatus('ğŸ’€ ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ï¼ã ã‚‹ã¾ã«è¦‹ã¤ã‹ã£ã¡ã‚ƒã£ãŸï¼');
                    return;
                }
                
                // å±é™ºçŠ¶æ…‹çµ‚äº†
                if (dangerDuration <= 0) {
                    gameState = 'playing';
                    daruma.isTurned = false;
                    // é ­ã‚’å…ƒã«æˆ»ã™ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                    const resetAnimation = () => {
                        daruma.headRotation -= 0.15;
                        if (daruma.headRotation <= 0) {
                            daruma.headRotation = 0;
                        } else {
                            requestAnimationFrame(resetAnimation);
                        }
                    };
                    resetAnimation();
                    
                    level = Math.floor(score / 200) + 1;
                    updateStatus('ğŸ‘ ã‚»ãƒ¼ãƒ•ï¼æ¬¡ã®éŸ³å£°ã‚’å¾…ã¨ã†...');
                    
                    // æ¬¡ã®éŸ³å£°å†ç”Ÿã¾ã§å°‘ã—å¾…ã¤
                    setTimeout(() => {
                        playDarumaVoice();
                    }, 1000 + Math.random() * 2000); // 1-3ç§’å¾Œ
                }
            }
        }

        // æç”»
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            drawBackground();
            drawPlayer();
            drawDaruma();
            drawUI();
        }

        // ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—
        function gameLoop() {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        // ã‚²ãƒ¼ãƒ é–‹å§‹
        gameLoop();
    </script>
</body>
</html>